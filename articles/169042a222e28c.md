---
title: "CronJobにnamespaceを書き忘れたらFluxのデプロイが全部止まった"
emoji: "💀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["kubernetes", "flux", "cronjob", "gitops"]
published: false
---

ある日、stg環境にデプロイが反映されないことに気づいた。

調べてみると Flux の reconcile がいつの間にか止まっていて、しばらくの間 stg も本番も手動で `kubectl apply` していたらしい。GitOps とは。

原因は **CronJob に `metadata.namespace` を書いていなかった**という単純なものだったけど、意外と気づきにくい。

## 何が起きたか

```
CronJob/xxx dry-run failed: namespace is required
```

<!-- TODO: 実際のエラーメッセージを確認 -->

厄介なのは、Kustomization 内の1つのリソースがエラーになると、**その Kustomization 全体の reconcile が止まる**こと。CronJob 以外の Deployment とかも巻き添えで更新されなくなっていた。

## なぜ起きたか

### kubectl と Flux の挙動の違い

`kubectl apply` は namespace 未指定だと `default` に作ってくれる。

```bash
# namespace 指定なしでも動く
kubectl apply -f cronjob.yaml
# → default namespace に作られる
```

一方、Flux はそういう親切な補完をしてくれない。dry-run の時点で「namespace がないぞ」と怒られて止まる。

### Flux の reconcile の流れ

Flux（kustomize-controller）がマニフェストを適用するとき、こんな流れで処理している：

1. Git リポジトリから変更を検知
2. `kustomize build` でマニフェストを生成
3. **server-side dry-run** でバリデーション ← ここでコケた
4. `kubectl apply` で実際に適用

dry-run は Kubernetes API サーバーに「これ適用したらどうなる？」と問い合わせる。このとき、namespaced なリソースに namespace がないと API サーバーが `namespace is required` で弾く。

`kubectl apply` を手動で叩くときは、kubectl が暗黙的に `default` や現在の context の namespace を補完してくれる。でも Flux の dry-run ではその補完が効かない。

### 問題のマニフェスト

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: my-cronjob
  # ← namespace がない
spec:
  schedule: "0 * * * *"
  jobTemplate:
    # ...
```

Deployment とかは最初から namespace 書いてたけど、後から足した CronJob だけ忘れてた。ローカルで `kubectl apply` したときは動いたから気づかなかった。

## 直し方

直し方は単純で、ちゃんと namespace を書くだけ。

```yaml
metadata:
  name: my-cronjob
  namespace: my-app
```

あるいは kustomization.yaml で指定しておく：

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: my-app
resources:
  - cronjob.yaml
```

## 再発防止

同じことを繰り返さないために、CI でチェックを入れることにした。

### kubeconform で検証

[kubeconform](https://github.com/yannh/kubeconform) を使うと、マニフェストのスキーマ検証ができる。ただし namespace の有無はデフォルトでは検証してくれないので、追加でチェックが必要。

### シンプルに grep する

雑だけど効く：

```bash
# namespace がないリソースを検出
for f in $(find k8s/ -name "*.yaml"); do
  if grep -q "^kind:" "$f" && ! grep -q "namespace:" "$f"; then
    echo "namespace missing: $f"
  fi
done
```

### kustomization.yaml で namespace を強制

そもそも個々のマニフェストに namespace を書かず、kustomization.yaml で一括指定するルールにするのもあり：

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: my-app  # ここで強制
resources:
  - deployment.yaml
  - service.yaml
  - cronjob.yaml
```

この方式なら書き忘れが起きない。ただし複数 namespace を扱うときは分ける必要がある。

### Flux の health check を監視する

そもそも reconcile が止まっていることに気づけなかったのも問題。Flux の Kustomization リソースの status を監視して、失敗したらアラートを飛ばすようにした。

```bash
# Kustomization の状態確認
flux get kustomizations
```

Slack 通知とかは [Flux の Notification Controller](https://fluxcd.io/flux/components/notification/) で設定できる。

## 同じ問題で困ってる人へ

Flux の GitHub にも Issue がある：

https://github.com/fluxcd/flux2/issues/2666

`kubectl apply` で動くからといって Flux で動くとは限らない。Flux は dry-run で厳密にチェックするので、namespace は省略しないほうが安全。同じようなハマり方をした人の参考になれば。
